<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Argerich">
  <meta name="theme-color" content="#f2f2f7">
  
  <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB3aWR0aD0iMTgwIiBoZWlnaHQ9iMTgwIiB2aWV3Qm94PSIwIDAgMTgwIDE4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9iMTgwIiBoZWlnaHQ9iMTgwIiByeD0iNDAiIGZpbGw9IiMwMDUyQTQiLz4KPHBhdGggZD0iTTkwIDMwIEw1MCA1MCBMNTAgODUgQzUwIDEwNSA4NSA5NSA5MCA5NSBDOTUgOTUgMTMwIDEwNSAxMzAgODUgTDEzMCA1MCBaIiBmaWxsPSJ3aGl0ZSIvPgo8cmVjdCB4PSI4MiIgeT0iNDUiIHdpZHRoPSIxNiIgaGVpZ2h0PSI0MCIgZmlsbD0iIzAwNTJBNCIvPgo8cmVjdCB4PSI3MCIgeT0iNTciIHdpZHRoPSI0MCIgaGVpZ2h0PSIxNiIgZmlsbD0iIzAwNTJBNCIvPgo8L3N2Zz4K">

  <title>App Patolog√≠a Argerich</title>
  <script src="https://unpkg.com/html5-qrcode"></script>

  <style>
    :root { --argerich: #0052a4; --bg: #f2f2f7; --card-bg: #ffffff; --text: #1c1c1e; --subtext: #8e8e93; --danger: #ff3b30; --success: #34c759; }
    
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
    html, body { 
      margin: 0; padding: 0; width: 100vw; height: 100vh; 
      background-color: var(--bg); font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif; 
      overflow: hidden; position: fixed; top: 0; left: 0;
      -webkit-user-select: none; user-select: none;
      overscroll-behavior: none;
    }

    .app-container { height: 100%; display: flex; flex-direction: column; }
    
    .header { 
      padding: env(safe-area-inset-top, 40px) 20px 15px; 
      background: rgba(242, 242, 247, 0.8); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      border-bottom: 0.5px solid rgba(0,0,0,0.1); display: flex; align-items: center; gap: 15px; z-index: 100; flex-shrink: 0;
    }
    .logo { width: 36px; height: 36px; background: var(--argerich); border-radius: 10px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0, 82, 164, 0.3); }
    .header-text h1 { margin: 0; font-size: 17px; font-weight: 700; color: var(--text); letter-spacing: -0.5px; }
    .header-text h2 { margin: 0; font-size: 11px; font-weight: 500; color: var(--subtext); text-transform: uppercase; letter-spacing: 0.5px; }

    .content { flex-grow: 1; overflow-y: auto; padding: 20px; -webkit-overflow-scrolling: touch; display: flex; flex-direction: column; align-items: center; padding-bottom: 40px; }
    
    .view { display: none; width: 100%; max-width: 400px; flex-direction: column; animation: fadeSlideUp 0.3s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
    .view.active { display: flex; }
    @keyframes fadeSlideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .scanner-card { background: var(--card-bg); border-radius: 20px; padding: 15px; box-shadow: 0 8px 30px rgba(0,0,0,0.06); width: 100%; margin-bottom: 20px; }
    #reader { width: 100%; border-radius: 14px; overflow: hidden; background: #000; display: none; margin-bottom: 15px; position: relative; }
    #reader__scan_region { border: 3px solid var(--argerich); border-radius: 12px; }
    #reader video { object-fit: cover; width: 100%; height: 100%; }
    
    .btn { width: 100%; padding: 16px; border-radius: 14px; border: none; font-weight: 600; font-size: 17px; cursor: pointer; transition: transform 0.1s; -webkit-appearance: none; }
    .btn:active { transform: scale(0.97); opacity: 0.8; }
    .btn-primary { background: var(--argerich); color: white; box-shadow: 0 4px 15px rgba(0, 82, 164, 0.2); }
    .btn-secondary { background: #e5e5ea; color: var(--text); margin-top: 10px; }

    .form-card { background: var(--card-bg); border-radius: 20px; padding: 25px 20px; box-shadow: 0 8px 30px rgba(0,0,0,0.06); width: 100%; }
    .product-title { font-size: 24px; font-weight: 800; text-align: center; margin: 0 0 5px 0; color: var(--text); letter-spacing: -0.5px; }
    .stock-badge { align-self: center; padding: 6px 16px; border-radius: 8px; background: rgba(0, 82, 164, 0.1); color: var(--argerich); font-weight: 700; font-size: 13px; margin: 0 auto 25px; display: table; }
    
    label { font-size: 10px; font-weight: 600; color: var(--subtext); text-transform: uppercase; margin-bottom: 8px; display: block; letter-spacing: 0.5px; padding-left: 4px; }
    select { width: 100%; padding: 14px; border-radius: 12px; border: none; background: #f2f2f7; font-size: 16px; color: var(--text); font-weight: 500; margin-bottom: 20px; -webkit-appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20width%3D%2214%22%20height%3D%228%22%20viewBox%3D%220%200%2014%208%22%20fill%3D%22none%22%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%3E%3Cpath%20d%3D%22M1%201L7%207L13%201%22%20stroke%3D%22%238E8E93%22%20stroke-width%3D%222%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22/%3E%3C/svg%3E'); background-repeat: no-repeat; background-position: right 15px center; background-size: 12px; }
    
    .toggle-row { display: flex; gap: 10px; margin-bottom: 25px; background: #f2f2f7; padding: 4px; border-radius: 14px; }
    .tgl { flex: 1; padding: 12px; border-radius: 10px; border: none; background: transparent; font-weight: 600; color: var(--subtext); font-size: 15px; transition: 0.3s; }
    .tgl.active { background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.08); color: var(--text); }
    .tgl.active.take { color: var(--danger); }
    .tgl.active.add { color: var(--success); }

    .qty-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 30px; background: #f2f2f7; border-radius: 20px; padding: 10px; }
    .qty-btn { width: 50px; height: 50px; border-radius: 14px; border: none; background: white; color: var(--text); font-size: 28px; font-weight: 400; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .qty-val { font-size: 40px; font-weight: 700; color: var(--argerich); text-align: center; flex-grow: 1; letter-spacing: -1px; }

    .status-container { text-align: center; padding: 40px 20px; width: 100%; max-width: 400px; background: white; border-radius: 20px; box-shadow: 0 8px 30px rgba(0,0,0,0.06); }
    .spinner { border: 4px solid rgba(0,0,0,0.05); border-left-color: var(--argerich); border-radius: 50%; width: 40px; height: 40px; animation: spin 0.8s linear infinite; margin: 0 auto 20px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .icon-success { font-size: 70px; margin-bottom: 10px; animation: popIn 0.5s cubic-bezier(0.2, 0.8, 0.2, 1.2); }
    @keyframes popIn { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
  </style>
</head>
<body>

  <div class="app-container">
    <div class="header">
      <div class="logo">
        <svg viewBox="0 0 100 100" width="20" height="20"><path d="M50 5 L10 25 L10 60 C10 80 45 95 50 95 C55 95 90 80 90 60 L90 25 Z" fill="white"/><rect x="42" y="30" width="16" height="40" fill="#0052a4"/><rect x="30" y="42" width="40" height="16" fill="#0052a4"/></svg>
      </div>
      <div class="header-text">
        <h2>Hospital Argerich</h2>
        <h1>App Patolog√≠a</h1>
      </div>
    </div>

    <div class="content">
      <div id="view-scan" class="view active">
        <div class="scanner-card">
          <h3 style="margin-top:0; text-align:center; color:var(--text); font-size:18px;">Lector de Insumos</h3>
          <p id="cam-hint" style="text-align:center; color:var(--subtext); font-size:14px; margin-bottom:20px;">Habilite la c√°mara para escanear el c√≥digo.</p>
          <div id="reader"></div>
          <button id="btn-start" class="btn btn-primary" onclick="iniciarCamara()">üì∑ Iniciar C√°mara</button>
        </div>
      </div>

      <div id="view-form" class="view">
        <div class="form-card">
          <h2 class="product-title" id="txt-prod">Nombre</h2>
          <div class="stock-badge" id="txt-stock">STOCK: 0</div>
          
          <label>Responsable</label>
          <select id="sel-user"><option>Andrea</option><option>Sebas</option><option>Marina</option><option>Roberto</option></select>
          
          <label>Ubicaci√≥n</label>
          <select id="sel-loc"><option>Heladera</option><option>Alacena</option><option>Dep√≥sito Central</option></select>

          <div class="toggle-row">
            <button class="tgl active take" id="tgl-take" onclick="setMode('take')">Retirar</button>
            <button class="tgl add" id="tgl-add" onclick="setMode('add')">Ingresar</button>
          </div>

          <div class="qty-row">
            <button class="qty-btn" onclick="chgQty(-1)">‚àí</button>
            <div class="qty-val" id="txt-qty">1</div>
            <button class="qty-btn" onclick="chgQty(1)">+</button>
          </div>

          <button class="btn btn-primary" onclick="doSave()">Confirmar Registro</button>
          <button class="btn btn-secondary" onclick="reiniciarApp()">Cancelar</button>
        </div>
      </div>

      <div id="view-loading" class="view" style="justify-content:center; flex-grow:1;">
        <div class="status-container">
          <div class="spinner"></div>
          <h2 id="load-msg" style="color: var(--text); font-size:18px;">Procesando...</h2>
        </div>
      </div>

      <div id="view-success" class="view" style="justify-content:center; flex-grow:1;">
        <div class="status-container">
          <div class="icon-success">‚úÖ</div>
          <h2 style="color: var(--text); font-size:24px; margin-bottom:5px;">Operaci√≥n Exitosa</h2>
          <p style="color: var(--subtext); margin-bottom: 30px;">Stock actualizado: <b id="txt-final" style="color: var(--text);">0</b></p>
          <button class="btn btn-primary" onclick="reiniciarApp()">Escanear Otro</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // LINK OFICIAL INTEGRADO
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwa2HiiSrn2uE8Ic9Jz_MTpnEqG-FgwTyBkcMEomWSC1vCfPBahiH01F4tWP-GWD5Mutw/exec'; 
    
    let html5QrCode; let currentId = ''; let qty = 1; let mode = 'take'; let unidad = '';

    function showView(id) {
      document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    function iniciarCamara() {
      if (html5QrCode) { html5QrCode.clear(); }
      html5QrCode = new Html5Qrcode("reader");
      
      const config = { fps: 15, qrbox: { width: 220, height: 220 } };
      
      html5QrCode.start({ facingMode: "environment" }, config, (decodedText) => {
        html5QrCode.stop().then(() => { 
          if(navigator.vibrate) navigator.vibrate(50); 
          loadProduct(decodedText); 
        });
      }).then(() => {
          document.getElementById('btn-start').style.display = 'none';
          document.getElementById('cam-hint').style.display = 'none';
          document.getElementById('reader').style.display = 'block';
      }).catch(err => {
        alert("Active los permisos de c√°mara en Safari.");
        reiniciarApp();
      });
    }

    function loadProduct(id) {
      showView('view-loading');
      document.getElementById('load-msg').innerText = "Validando c√≥digo...";
      fetch(`${SCRIPT_URL}?id=${id}`)
        .then(r => r.json())
        .then(res => {
          if(res.status === 'success') {
            currentId = id; qty = 1; unidad = res.unidad;
            document.getElementById('txt-prod').innerText = res.producto;
            document.getElementById('txt-stock').innerText = "STOCK ACTUAL: " + res.stock + " " + unidad;
            document.getElementById('txt-qty').innerText = qty;
            setMode('take'); showView('view-form');
          } else {
            alert("El c√≥digo no existe."); reiniciarApp();
          }
        }).catch(err => { alert("Error de conexi√≥n."); reiniciarApp(); });
    }

    function chgQty(n) { qty = Math.max(1, qty + n); document.getElementById('txt-qty').innerText = qty; }
    
    function setMode(m) {
      mode = m;
      document.getElementById('tgl-take').className = 'tgl take' + (m==='take'?' active':'');
      document.getElementById('tgl-add').className = 'tgl add' + (m==='add'?' active':'');
    }

    function doSave() {
      showView('view-loading');
      document.getElementById('load-msg').innerText = "Impactando inventario...";
      const data = { id: currentId, action: mode, qty: qty, user: document.getElementById('sel-user').value, acopio: document.getElementById('sel-loc').value };
      
      fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(data), headers: { "Content-Type": "text/plain;charset=utf-8" } })
      .then(r => r.json())
      .then(res => {
        if(res.status === 'success') {
          document.getElementById('txt-final').innerText = res.stock + " " + unidad; showView('view-success');
        } else {
          alert("Error al guardar."); showView('view-form');
        }
      });
    }

    function reiniciarApp() {
      showView('view-scan');
      document.getElementById('btn-start').style.display = 'block';
      document.getElementById('cam-hint').style.display = 'block';
      document.getElementById('reader').style.display = 'none';
      if(html5QrCode) html5QrCode.clear();
    }
  </script>
</body>
</html>
