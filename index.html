<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Argerich">
  <meta name="theme-color" content="#f2f2f7">
  
  <title>App Patología</title>
  <script src="https://unpkg.com/html5-qrcode"></script>

  <style>
    /* VARIABLES APPLE HEALTH STYLE */
    :root { --argerich: #0052a4; --bg: #f2f2f7; --card-bg: #ffffff; --text: #1c1c1e; --subtext: #8e8e93; --danger: #ff3b30; --success: #34c759; }
    
    /* ELIMINAR COMPORTAMIENTO WEB (Bounce y Selección) */
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body { 
      margin: 0; padding: 0; width: 100vw; height: 100vh; 
      background-color: var(--bg); font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif; 
      overflow: hidden; /* Adiós rebote de Safari */
      position: fixed; top: 0; left: 0;
      -webkit-user-select: none; user-select: none; /* Adiós texto seleccionable */
      overscroll-behavior: none;
    }

    /* CONTENEDOR PRINCIPAL 16:9 ALINEADO */
    .app-container { height: 100%; display: flex; flex-direction: column; }
    
    /* HEADER GLASSMORPHISM (Vidrio Apple) */
    .header { 
      padding: env(safe-area-inset-top, 40px) 20px 15px; 
      background: rgba(242, 242, 247, 0.8); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      border-bottom: 0.5px solid rgba(0,0,0,0.1); display: flex; align-items: center; gap: 15px; z-index: 100; flex-shrink: 0;
    }
    .logo { width: 36px; height: 36px; background: var(--argerich); border-radius: 10px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0, 82, 164, 0.3); }
    .header-text h1 { margin: 0; font-size: 17px; font-weight: 700; color: var(--text); letter-spacing: -0.5px; }
    .header-text h2 { margin: 0; font-size: 12px; font-weight: 500; color: var(--subtext); text-transform: uppercase; }

    /* CONTENIDO SCROLLEABLE LIMPIO */
    .content { flex-grow: 1; overflow-y: auto; padding: 20px; -webkit-overflow-scrolling: touch; display: flex; flex-direction: column; align-items: center; padding-bottom: 40px; }
    
    /* ANIMACIONES SUAVES */
    .view { display: none; width: 100%; max-width: 400px; flex-direction: column; animation: fadeSlideUp 0.4s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
    .view.active { display: flex; }
    @keyframes fadeSlideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

    /* CÁMARA 16:9 */
    .scanner-card { background: var(--card-bg); border-radius: 20px; padding: 15px; box-shadow: 0 8px 30px rgba(0,0,0,0.06); width: 100%; margin-bottom: 20px; }
    #reader { width: 100%; aspect-ratio: 16/9; border-radius: 14px; overflow: hidden; background: #000; display: none; margin-bottom: 15px; }
    #reader video { object-fit: cover; }
    
    /* BOTONES NATIVOS iOS */
    .btn { width: 100%; padding: 16px; border-radius: 14px; border: none; font-weight: 600; font-size: 17px; cursor: pointer; transition: transform 0.1s, opacity 0.2s; }
    .btn:active { transform: scale(0.97); opacity: 0.8; }
    .btn-primary { background: var(--argerich); color: white; box-shadow: 0 4px 15px rgba(0, 82, 164, 0.2); }
    .btn-secondary { background: #e5e5ea; color: var(--text); margin-top: 10px; }

    /* TARJETA DE FORMULARIO */
    .form-card { background: var(--card-bg); border-radius: 20px; padding: 25px 20px; box-shadow: 0 8px 30px rgba(0,0,0,0.06); width: 100%; }
    .product-title { font-size: 24px; font-weight: 800; text-align: center; margin: 0 0 5px 0; color: var(--text); letter-spacing: -0.5px; }
    .stock-badge { align-self: center; padding: 6px 16px; border-radius: 8px; background: rgba(0, 82, 164, 0.1); color: var(--argerich); font-weight: 700; font-size: 13px; margin: 0 auto 25px; display: table; }
    
    label { font-size: 11px; font-weight: 600; color: var(--subtext); text-transform: uppercase; margin-bottom: 8px; display: block; letter-spacing: 0.5px; }
    select { width: 100%; padding: 14px; border-radius: 12px; border: none; background: #f2f2f7; font-size: 16px; color: var(--text); font-weight: 500; margin-bottom: 20px; -webkit-appearance: none; }
    
    .toggle-row { display: flex; gap: 10px; margin-bottom: 25px; background: #f2f2f7; padding: 4px; border-radius: 14px; }
    .tgl { flex: 1; padding: 12px; border-radius: 10px; border: none; background: transparent; font-weight: 600; color: var(--subtext); font-size: 15px; transition: 0.3s; }
    .tgl.active { background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.08); color: var(--text); }
    .tgl.active.take { color: var(--danger); }
    .tgl.active.add { color: var(--success); }

    /* CONTROLADORES DE CANTIDAD */
    .qty-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 30px; background: #f2f2f7; border-radius: 20px; padding: 10px; }
    .qty-btn { width: 50px; height: 50px; border-radius: 14px; border: none; background: white; color: var(--text); font-size: 28px; font-weight: 400; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .qty-val { font-size: 40px; font-weight: 700; color: var(--argerich); text-align: center; flex-grow: 1; letter-spacing: -1px; }

    /* VISTAS DE CARGA Y ÉXITO */
    .status-container { text-align: center; padding: 40px 20px; }
    .spinner { border: 4px solid rgba(0,0,0,0.05); border-left-color: var(--argerich); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .icon-success { font-size: 70px; margin-bottom: 10px; animation: popIn 0.5s cubic-bezier(0.2, 0.8, 0.2, 1.2); }
    @keyframes popIn { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
  </style>
</head>
<body>

  <div class="app-container">
    <div class="header">
      <div class="logo">
        <svg viewBox="0 0 100 100" width="20" height="20"><path d="M50 5 L10 25 L10 60 C10 80 45 95 50 95 C55 95 90 80 90 60 L90 25 Z" fill="white"/><rect x="42" y="30" width="16" height="40" fill="#0052a4"/><rect x="30" y="42" width="40" height="16" fill="#0052a4"/></svg>
      </div>
      <div class="header-text">
        <h2>Hospital Argerich</h2>
        <h1>App Patología</h1>
      </div>
    </div>

    <div class="content">
      
      <div id="view-scan" class="view active">
        <div class="scanner-card">
          <h3 style="margin-top:0; text-align:center; color:var(--text); font-size:18px;">Lector Activo</h3>
          <p id="cam-hint" style="text-align:center; color:var(--subtext); font-size:14px; margin-bottom:20px;">Toque el botón para habilitar la lente 16:9.</p>
          <div id="reader"></div>
          <button id="btn-start" class="btn btn-primary" onclick="iniciarCamara()">Habilitar Cámara</button>
        </div>
      </div>

      <div id="view-form" class="view">
        <div class="form-card">
          <h2 class="product-title" id="txt-prod">Nombre</h2>
          <div class="stock-badge" id="txt-stock">STOCK: 0</div>
          
          <label>Responsable de Guardia</label>
          <select id="sel-user"><option>Andrea</option><option>Sebas</option><option>Marina</option><option>Roberto</option></select>
          
          <label>Ubicación del Insumo</label>
          <select id="sel-loc"><option>Heladera</option><option>Alacena</option><option>Depósito Central</option></select>

          <div class="toggle-row">
            <button class="tgl active take" id="tgl-take" onclick="setMode('take')">Retirar</button>
            <button class="tgl add" id="tgl-add" onclick="setMode('add')">Ingresar</button>
          </div>

          <div class="qty-row">
            <button class="qty-btn" onclick="chgQty(-1)">−</button>
            <div class="qty-val" id="txt-qty">1</div>
            <button class="qty-btn" onclick="chgQty(1)">+</button>
          </div>

          <button class="btn btn-primary" onclick="doSave()">Confirmar Movimiento</button>
          <button class="btn btn-secondary" onclick="reiniciarApp()">Cancelar</button>
        </div>
      </div>

      <div id="view-loading" class="view" style="justify-content:center; flex-grow:1;">
        <div class="status-container">
          <div class="spinner"></div>
          <h2 id="load-msg" style="color: var(--text); font-size:18px;">Procesando...</h2>
        </div>
      </div>

      <div id="view-success" class="view" style="justify-content:center; flex-grow:1;">
        <div class="status-container">
          <div class="icon-success">✅</div>
          <h2 style="color: var(--text); font-size:24px; margin-bottom:5px;">Operación Exitosa</h2>
          <p style="color: var(--subtext); margin-bottom: 30px;">Stock actualizado a: <b id="txt-final" style="color: var(--text);">0</b></p>
          <button class="btn btn-primary" onclick="reiniciarApp()">Finalizar y Volver</button>
        </div>
      </div>

    </div>
  </div>

  <script>
    // ⚠️ REVISÁ QUE TENGAS TU LINK ACÁ
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwa2HiiSrn2uE8Ic9Jz_MTpnEqG-FgwTyBkcMEomWSC1vCfPBahiH01F4tWP-GWD5Mutw/exec'; 
    
    let html5QrCode; let currentId = ''; let qty = 1; let mode = 'take'; let unidad = '';

    function showView(id) {
      document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      // Feedback háptico sutil (si el celular lo soporta)
      if(navigator.vibrate) navigator.vibrate(10); 
    }

    function iniciarCamara() {
      document.getElementById('btn-start').style.display = 'none';
      document.getElementById('cam-hint').style.display = 'none';
      document.getElementById('reader').style.display = 'block';

      if (html5QrCode) { html5QrCode.clear(); }
      html5QrCode = new Html5Qrcode("reader");
      
      // Forzamos el formato 16:9 y optimizamos los frames
      const config = { fps: 15, qrbox: { width: 250, height: 250 }, aspectRatio: 1.777778 };
      
      html5QrCode.start({ facingMode: "environment" }, config, (decodedText) => {
        html5QrCode.stop().then(() => { 
          if(navigator.vibrate) navigator.vibrate([30, 50, 30]); // Vibración de escaneo exitoso
          loadProduct(decodedText); 
        });
      }).catch(err => {
        reiniciarApp();
      });
    }

    function loadProduct(id) {
      showView('view-loading');
      document.getElementById('load-msg').innerText = "Validando código...";
      
      fetch(`${SCRIPT_URL}?id=${id}`)
        .then(r => r.json())
        .then(res => {
          if(res.status === 'success') {
            currentId = id; qty = 1; unidad = res.unidad;
            document.getElementById('txt-prod').innerText = res.producto;
            document.getElementById('txt-stock').innerText = "STOCK DISPONIBLE: " + res.stock + " " + unidad;
            document.getElementById('txt-qty').innerText = qty;
            setMode('take'); showView('view-form');
          } else {
            showView('view-scan'); // Falla silenciosa suave
          }
        }).catch(err => { showView('view-scan'); });
    }

    function chgQty(n) { 
      qty = Math.max(1, qty + n); 
      document.getElementById('txt-qty').innerText = qty; 
      if(navigator.vibrate) navigator.vibrate(10); 
    }
    
    function setMode(m) {
      mode = m;
      document.getElementById('tgl-take').className = 'tgl take' + (m==='take'?' active':'');
      document.getElementById('tgl-add').className = 'tgl add' + (m==='add'?' active':'');
      if(navigator.vibrate) navigator.vibrate(10);
    }

    function doSave() {
      showView('view-loading');
      document.getElementById('load-msg').innerText = "Impactando inventario...";
      const data = { id: currentId, action: mode, qty: qty, user: document.getElementById('sel-user').value, acopio: document.getElementById('sel-loc').value };
      
      fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(data), headers: { "Content-Type": "text/plain;charset=utf-8" } })
      .then(r => r.json())
      .then(res => {
        if(res.status === 'success') {
          if(navigator.vibrate) navigator.vibrate([50, 100, 50]); // Vibración de éxito
          document.getElementById('txt-final').innerText = res.stock + " " + unidad; showView('view-success');
        } else {
          showView('view-form');
        }
      });
    }

    function reiniciarApp() {
      showView('view-scan');
      document.getElementById('btn-start').style.display = 'block';
      document.getElementById('cam-hint').style.display = 'block';
      document.getElementById('reader').style.display = 'none';
    }
  </script>
</body>
</html>
